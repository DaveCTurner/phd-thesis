\section{Categories of FM-Continuous Maps}
\label{fmcts}

As in the development of HOPLA, linear maps are too restrictive to give a
semantics for concurrent processes: it is desirable for a process to be able to
perform actions spontaneously and without having received any input, but linear
maps are join-preserving so that they preserve empty joins in particular and
hence a linear process with no input can generate no output.

The solution to this issue is be to consider maps which are continuous (with
respect to some notion of approximation) rather than merely linear. In the
development of HOPLA\cite{nygaardwinskel1}, continuity was chosen to mean
`preserves directed joins' but the discussion of \ref{bindingdiscts}
demonstrates that this is not a suitable choice in $\mathbf{FMLin}_s$.
Reconsidering directed sets as generalised sequences in \ref{fm:continuity}
suggests a more satisfactory definition of continuity. Section \ref{fm:isolated}
demonstrates that it is simple to characterise the elements that are isolated
with respect to this notion of approximation, and this gives rise to an
appropriate exponential ${!}$ that captures the continuity in much the same way
that the finite-join-completion exponential does in HOPLA.

\TODO{Complete this intro when this section is complete.}

\subsection{Name-Binding is Directed-Join Discontinuous}
\label{bindingdiscts}

It is now necessary to speculate a little on what a nominal extension to the
process calculus HOPLA may look like. This speculation is motivated by the
development of new-HOPLA\cite{WZ04}.

A key feature of a nominal extension to HOPLA would be terms of the form
$\new{a}{t}$ whose intended meaning is to bind the name $a$ in the outputs of
$t$. In particular there will be a term $\new{a}{\termvar{x}}$ (where
$\termvar{x}$ is a free variable) which receives a process as input and binds
the name $a$ in its output. As the effect of $\new{a}{t}$ is to bind $a$, if $b$
is a fresh name then it should be the case that $\new{a}{t} = \new{b}{\bigl((ab)
\cdot t\bigr)}$, and in particular the name $a$ should not be in the support of
$\new{a}{t}$. The semantics of $\new{a}{t}$ are motivated by the semantics of
$\new{\alpha}{t}$ from new-HOPLA.

Now consider the term $\ndsum{b}{\mathbb A}{\labelaction{b}{\bang{\inactive}}}$
which nondeterministically chooses a name $b$ and outputs it. Recall that the
type of a HOPLA term corresponds to the actions that it can do, so the type of
this process will be (isomorphic to) $\mathbb A$ since its possible actions are
(essentially) outputs of elements of $\mathbb A$. Furthermore, it is closed so
its denotation will simply be a subset of $\mathbb A$, and since it can output
any name it must be that \begin{equation} \label{allnamesum}
\sem{\ndsum{b}{\mathbb A}{\labelaction{b}{\bang{\inactive}}}} = \mathbb A.
\end{equation}

The term $\new{a}{\bigl(\ndsum{b}{\mathbb A}{\labelaction{b}{\bang{\inactive}}
}\bigr)}$ should be able to output a bound name $\newaction{a}{a}$ if it is to
satisfy the same operational semantics as new-HOPLA, and therefore
\begin{equation} \label{boundnameout} \new{a}{a} \in
\sem{\new{a}{\bigl(\ndsum{b}{\mathbb A}{\labelaction{b}{\bang{\inactive}}
}\bigr)}}. \end{equation}

Recall that in HOPLA substitution is given by composition of denotations. In
new-HOPLA, substitution under a $\new{a}{(-)}$ ensures that $a$ is a fresh name
before proceeding, but any $a$ is fresh here since $\ndsum{b}{\mathbb
A}{\labelaction{b}{\bang{\inactive}} }$ has empty support. Therefore
\begin{equation} \label{allnamecomp} \sem{\new{a}{\bigl(\ndsum{b}{\mathbb
A}{\labelaction{b}{\bang{\inactive}} }\bigr)}} = \sem{\new{a}{\termvar{x}}}
\circ \sem{\ndsum{b}{\mathbb A}{\labelaction{b}{\bang{\inactive}} }} =
\sem{\new{a}{\termvar{x}}} (\mathbb A). \end{equation}

Now $\mathbb A = \bigcup_{s \subseteq_{\mathrm{fin}} \mathbb A} s$ is a directed
join, so if $\sem{\new{a}{\termvar{x}}}$ is continuous then \begin{equation}
\label{allnamejoin} \sem{\new{a}{\termvar{x}}} (\mathbb A) =
\sem{\new{a}{\termvar{x}}} \left(\bigcup_{s \subseteq_{\mathrm{fin}} \mathbb A}
s \right) = \bigcup_{s \subseteq_{\mathrm{fin}} \mathbb A}
\sem{\new{a}{\termvar{x}} } s, \end{equation} so it follows that $\new{a}{a} \in
\bigcup_{s \subseteq_{\mathrm{fin}} \mathbb A} \sem{\new{a}{\termvar{x}} } s$.
Let $\{b_1, \ldots, b_n\}$ be such that \begin{equation} \label{boundnamein}
\newaction{a}{a} \in \sem{\new{a}{\termvar{x}}} \{b_1, \ldots, b_n\} =
\sem{\new{a}{\termvar{x}}} \circ \sem{\linj{b_1}{\bang{\inactive}}
\mathop{\mathtt{+}} \ldots \mathop{\mathtt{+}} \linj{b_n}{\bang{\inactive}}}.
\end{equation}

Again, note that substitution under a $\new{a}{(-)}$ ensures that $a$ is a fresh
name in new-HOPLA. In particular $a'$ may be chosen so that it is distinct from
the $b_i$ and rewrite $\new{a}{\termvar{x}}$ as $\new{a'}{\termvar{x}}$ since
the term $\termvar{x}$ is unaffected by permutations of names and therefore has
empty support.  Therefore \begin{equation} \label{allnamecomp:finite}
\sem{\new{a}{\termvar{x}}} \circ \sem{\linj{b_1}{\bang{\inactive}}
\mathop{\mathtt{+}} \ldots \mathop{\mathtt{+}} \linj{b_n}{\bang{\inactive}}} =
\{ \new{a'}{b_1}, \ldots, \new{a'}{b_n} \}.  \end{equation} But this is a
contradiction: $\new{a}{a} = \new{a'}{a'} \neq \new{a'}{b_i}$ for any $i$ as
$a'$ was chosen to be fresh.
%
From all of the speculative assumptions made in this example, the least
convincing is that $\sem{\new{a}{t}}$ must preserve directed joins, so it is
sensible to seek an alternative notion of continuity that includes maps such as
$\sem{\new{a}{t}}$.

\subsection{FM-Continuity}
\label{fm:continuity}

In some sense the notion of limits of directed sets is the intuitionistic ---
and therefore computational --- analogue of a limit of a (transfinite) sequence
in point-set topology. Classically, a domain has limits of all increasing
sequences iff it has limits of all directed sets: increasing sequences give rise
to directed sets, and conversely given a well-ordered directed set the
well-ordering gives rise to an increasing sequence. The Axiom of Choice ensures
that all directed sets have well-orderings.
%
However, the Axiom of Choice does not hold in the theory of FM sets, so the
equivalence between the use of sequences and of directed sets breaks down here.

\begin{definition} An \define{FM-sequence} in a domain $D$ is a sequence (i.e. a
function from some ordinal $\alpha$ to $D$) that is additionally
finitely-supported.  \end{definition} 

If the sequence is supported by $s$ then each element must also be supported by
$s$ since ordinals have empty support: this support is said to be
\textit{uniform} since it applies uniformly to all of the elements of the
sequence. Furthermore any uniformly supported sequence is an FM-sequence.

\begin{definition} An FM set $X$ is \define{uniformly supported} by $s$ if every
element $x \in X$ is supported by $s$. An FM set \define{has uniform support} if
there exists a finite set $s$ that uniformly supports it. \end{definition}

Classical sequences are to directed sets as uniformly supported sequences are to
directed sets that are also uniformly supported. More precisely, an FM preorder
has limits of all increasing uniformly supported sequences iff it has limits of
all uniformly supported directed sets: well-orderings of a uniformly supported
set are always finitely supported so the (external) Axiom of Choice gives rise
to an (internal) well-ordering and the remainder of the proof is as in the
classical case.

\TODO{Return to the example of $\sem{\new{a}{t}}$ and show that it is
FM-continuous}

\subsection{FM-Isolated Elements}
\label{fm:isolated}

Considering $\widehat{\typeP}$ as a domain of meanings for processes of type
$\typeP$, it is now sensible to investigate the structure of the isolated (or
compact or `finite') elements of this domain with respect to FM-continuity. 

\begin{definition} An element $x \in \widehat{\typeP}$ is \define{FM-isolated} 
iff for all uniformly supported directed sets $X \subseteq
\widehat{\typeP}$, if $x \subseteq \bigcup X$ then there exists $x' \in X$ such
that $x \subseteq x'$.  \end{definition}

For the purposes of this discussion it is unambiguous to call FM-isolated
elements simply `isolated'.

For example, all finitely-supported subsets of $\mathbb A$ are isolated in
$\widehat{\mathbb A}$. To see this, let $x \subseteq \mathbb A$ be
finitely-supported and such that $x \subseteq \bigcup X$ where $X \subseteq
\widehat{\mathbb A}$ is directed and uniformly supported by $s$, then every
element of $X$ is either a subset of $s$ or a superset of $\mathbb A \setminus
s$. Therefore $X$ is finite, and since it is also directed there must exist $x'
\in X$ such that $x \subseteq x'$.
%
More generally, \begin{definition} If $\typeP$ is a FM-preorder, $F$ a finite
subset of $\typeP$ and $s$ a finite set of names that contains $\supp{\typeP}$
then define \begin{equation} \label{def:finelt} \finelt{F}{s} \defeq
\bigcup_{\sigma \freshfor s} \sigma \cdot F_\downarrow. \end{equation}
\end{definition}

Every $x \in \widehat{\mathbb A}$ is of this form: either $x$ is finite and
hence $x = \finelt{x}{\supp{x}}$ or else $x$ is cofinite and hence $x =
\finelt{\{a\}}{\supp{x}}$ for any $a \in x$.
%
Lemma \ref{finelts} shows that sets of this form are precisely the isolated
elements of $\widehat{\typeP}$.
%
Corollary \ref{finelt:wlog} also shows that an appropriate $s$ may be chosen
relatively freely, as long as it is sufficiently large.
%
The set $\finelt{F}{s}$ is generated from $F$ by closure under the action of
certain permutations, and the origin of the notation $\finelt{F}{s}$ is by
analogy with a presentation of a group in terms of its generators: $\langle a,
b, \ldots \mid R(a, b, \ldots) \rangle$.

\begin{lemma} \label{finelt:mono} If $\supp{\typeP} \subseteq s \subseteq s'$
and $F' \subseteq F \subseteq_{\mathrm{fin}} \typeP$ then $\finelt{F'}{s'}
\subseteq \finelt{F}{s}$.\end{lemma}

\begin{proof} Let $p' \in \finelt{F'}{s'}$, then there exists $p \in F'$ and
$\sigma' \freshfor s'$ such that $p' \le_{\typeP} \sigma \cdot p$.
%
Also $F' \subseteq F$ so that $p \in F$ and $s \subseteq s'$ so that $\sigma
\freshfor s$ and hence $p' \in \finelt{F}{s}$ as required.\end{proof}

\begin{lemma}\label{fineltextension} If $\supp{\typeP} \subseteq s \subseteq s'$
and $F \subseteq \typeP$ is finite then there exists a finite $F' \subseteq
\typeP$ such that $\finelt{F}{s} = \finelt{F'}{s'}$.  \end{lemma}

\begin{proof} Let $\bar{s} = s' \cup \bigcup_{p \in F} \supp{p}$ and note that
since $F$ is finite, $\bar{s}$ is finite and $\supp{F} \subseteq \bar{s}$.  Let
$s''$ be a finite set of fresh names of greater cardinality that $\bar{s}$ and
let $\Sigma = \{\sigma \mid \supp{\sigma} \subseteq (\bar{s} \cup s'') \setminus
s \}$.  Let $F' = \bigcup_{\sigma \in \Sigma} \sigma \cdot F$ and note that
$\Sigma$ is finite, so that $F'$ is also finite. Show that $\finelt{F}{s} =
\finelt{F'}{s'}$ as follows.

Let $p \in \finelt{F}{s}$, then by definition there exists $\sigma$ and $p'$
where $\sigma \freshfor s$, $p' \in F$ and $p \le_{\typeP} \sigma \cdot p'$.  By
lemma \ref{footprint} there exists $\sigma_1$, $\sigma_2$, $\sigma_3$ such that
$\sigma = \sigma_1 \sigma_2 \sigma_3$ where $\sigma_1 \freshfor \bar{s}$ and
$\sigma_3 \freshfor \bar{s}$ and $\supp{\sigma_2} \subseteq (\bar{s} \cup s'')
\setminus s$.

Firstly, $\supp{F} \subseteq \bar{s}$ so that $\sigma_3 \cdot F = F$ and hence
$\sigma_3 \cdot p' \in F$.  Also, since $\sigma_2 \in \Sigma$, $\sigma_2 \cdot
\sigma_3 \cdot p' \in F'$.  Also, since $p \le_{\typeP} \sigma_1 \cdot \sigma_2
\cdot \sigma_3 \cdot p'$ it follows that $\sigma_1^{-1} \cdot p \le_{\typeP} \sigma_2 \cdot
\sigma_3 \cdot p' \in F'$ and hence $p \in \sigma_1 \cdot F'_{\downarrow}$.
Finally, $\sigma_1 \freshfor s'$ so that $p \in \finelt{F'}{s'}$ as required.

Conversely, let $p \in \finelt{F'}{s'}$, then there exists $\sigma$ and $p'$
where $\sigma \freshfor s'$, $p' \in F'$ and $p \le_{\typeP} \sigma \cdot p'$.
By definition of $F'$, there exists $\sigma'$ such that $p' \in \sigma' \cdot F$
and $\sigma' \freshfor s$. Therefore $p \le_{\typeP} \sigma \cdot p' = \sigma
\cdot \sigma' \cdot \sigma'^{-1} \cdot p' \in \sigma \cdot \sigma' \cdot F$.
Furthermore, $s \subseteq s'$ so that $\sigma \sigma' \freshfor s$ and hence $p
\in \finelt{F}{s}$ as required.
\end{proof}

\begin{lemma}
\label{fineltsupport}The support of $\finelt{F}{s}$ is contained in $s$.
\end{lemma}

\begin{proof} It is sufficient to show that if $\sigma \freshfor s$ then $\sigma
\cdot \finelt{F}{s} = \finelt{F}{s}$.  Let $p \in \finelt{F}{s}$, then there
exists $\sigma' \freshfor s$ and $p' \in F$ such that $p \le \sigma' \cdot p'$.
Then $\sigma \cdot p \le \sigma \cdot \sigma' \cdot p'$ and $\sigma\sigma'
\freshfor s$ so that $\sigma \cdot p \in \finelt{F}{s}$ and hence $\sigma \cdot
\finelt{F}{s} \subseteq \finelt{F}{s}$. The converse is similar.  \end{proof}

\begin{lemma}\label{finelts} An element $x \in \widehat{\typeP}$ is isolated iff
it is of the form $\finelt{F}{s}$ where $F$ is a finite subset of $\typeP$ and
$s$ is a finite set of names that contains the support of $\typeP$.  \end{lemma}

\begin{proof} Suppose that $\finelt{F}{s} \subseteq \bigcup X$ where $X
\subseteq \widehat{\typeP}$ is uniformly supported and directed.  In the light
of lemma \ref{fineltextension} suppose without loss of generality that $s$ is
large enough to be a uniform support for $X$. Let $F = \{p_1, \ldots, p_n\}$,
then for each $i \in \{1, \ldots, n\}$, $p_i \in \finelt{F}{s} \subseteq \bigcup
X$ so there exists $x_i \in X$ such that $p_i \in x_i$. Since $X$ is directed,
it contains an upper bound $\bar{x}$ for the $x_i$.  If $p \in \finelt{F}{s}$
then $p \le_{\typeP} \sigma \cdot p_i$ for some $i \in \{1, \ldots, n\}$ and
some $\sigma \freshfor s$. Therefore $p \in \sigma \cdot x_i \subseteq \sigma
\cdot \bar{x}$, but $s$ is a uniform support for $X$ so that $\sigma \cdot
\bar{x} = \bar{x}$ and hence $p \in \bar{x}$. Therefore $\finelt{F}{s}$ is
isolated.

Conversely, let $x \in \widehat{\typeP}$ be isolated, let $s = \supp{x} \cup
\supp{\typeP}$ and define $X \subseteq \widehat{\typeP}$ by $X = \{\finelt{F}{s}
\mid F \subseteq_{\mathrm{fin}} x\}$. From lemma \ref{fineltsupport} it follows
that $X$ is uniformly supported by $s$, and it is clear that if $F_1
\subseteq_{\mathrm{fin}} x$ and $F_2 \subseteq_{\mathrm{fin}} x$ then $F_1 \cup
F_2 \subseteq_{\mathrm{fin}} x$ and $\finelt{F_1 \cup F_2}{s}$ is an upper bound
for $\finelt{F_1}{s}$ and $\finelt{F_2}{s}$ so that $X$ is directed.  Therefore
by the isolation of $x$ there exists $F \subseteq_{\mathrm{fin}} x$ such that $x
\subseteq \finelt{F}{s}$. Furthermore, $\finelt{F}{s} \subseteq x$ as follows.
Let $p \in \finelt{F}{s}$, then there exists $\sigma \freshfor s$ and $p' \in F$
such that $p \le_{\typeP} \sigma \cdot p'$. Also, $F \subseteq x$ so that $p'
\in x$, and $\sigma \freshfor s$ so that $\sigma \cdot x = x$ and hence $p
\le_{\typeP} \sigma \cdot p' \in x \in \widehat{\typeP}$ so that $p \in x$.
Therefore $x = \finelt{F}{s}$ as required.  \end{proof}

\begin{lemma}
\label{finelteqvt} If $\sigma$ is a permutation and $\sigma \freshfor \typeP$
then \[\sigma \cdot \finelt{F}{s} = \finelt{\sigma \cdot F}{\sigma \cdot s}.\]
\end{lemma}

\begin{proof} Let $p' \in \sigma \cdot \finelt{F}{s}$ then there exists $p \in
F$ and $\sigma' \freshfor s$ such that $p' \le_{\typeP} \sigma \cdot \sigma'
\cdot p = \sigma \cdot \sigma' \cdot \sigma^{-1} \cdot \sigma \cdot p$, and
$\sigma \cdot p \in \sigma \cdot F$ and $\sigma \sigma' \sigma^{-1} \freshfor
\sigma \cdot s$ so that $p' \in \finelt{\sigma \cdot F}{\sigma \cdot s}$. The
converse case is similar.  \end{proof}

\begin{lemma}
\label{fineltminsupp} If $F \subseteq_{\mathrm{fin}} \typeP$ and $\supp{\typeP}
\subseteq s$ then \[\finelt{F}{s} = \finelt{F}{\supp{\finelt{F}{s}, \typeP}}.\]
\end{lemma}

\begin{proof} Let $p' \in \finelt{F}{s}$ then there exists $p \in F$ and $\sigma
\freshfor s$ such that $p' \le_{\typeP} \sigma \cdot p$.
%
By lemma \ref{fineltsupport}, $\supp{\finelt{F}{s}} \subseteq s$ so that $\sigma
\freshfor \finelt{F}{s}$; furthermore $\sigma \freshfor \typeP$ as
$\supp{\typeP} \subseteq s$ so that $p' \in \finelt{F}{\supp{\finelt{F}{s},
\typeP}}$.
%
Conversely, let $p' \in \finelt{F}{\supp{\finelt{F}{s}, \typeP}}$ then there
exists $p \in F$ and $\sigma \freshfor \finelt{F}{s}, \typeP$ such that $p'
\le_{\typeP} \sigma \cdot p = \iota \cdot \sigma \cdot p$ and $\iota \freshfor
\sigma \cdot s$ so that $p' \in \finelt{\sigma \cdot F}{\sigma \cdot s} = \sigma
\cdot \finelt{F}{s} = \finelt{F}{s}$ as required.  \end{proof}

\begin{corollary} \label{finelt:wlog} If $x \in \widehat{\typeP}$ is isolated
and $\supp{x, \typeP} \subseteq s$ then there exists $F \subseteq_{\mathrm{fin}}
\typeP$ such that $x = \finelt{F}{s}$.  \end{corollary}

\begin{proof} If $x$ is isolated then by \ref{finelts} there exists finite $F'
\subseteq \typeP$ and finite $s' \supseteq \supp{\typeP}$ such that $x =
\finelt{F'}{s'}$.
%
By \ref{fineltminsupp} therefore $x = \finelt{F'}{\supp{x, \typeP}}$ and by
\ref{fineltextension} there exists $F \subseteq_{\mathrm{fin}} \typeP$ such that
$x = \finelt{F}{s}$ as required. \end{proof}

\subsection{FM-Continuous Maps}
\label{fmcts:maps}

The discussion of the previous section indicates that `continuous' should mean
`preserves joins of uniformly-supported directed sets' or equivalently
`preserves joins of increasing sequences' - for brevity this will be called
`FM-continuous'. Let $\mathbf{FMCts}_s$ be the category whose objects are
FM-preorders $\typeP$, $\typeQ$, $\ldots$ supported by $s$ and whose arrows
$\typeP \to \typeQ$ are maps $\widehat{\typeP} \to \widehat{\typeQ}$ that are
FM-continuous and supported by $s$. Note that in particular FM-linear maps are
FM-continuous so that $\mathbf{FMLin}_s$ is a subcategory of $\mathbf{FMCts}_s$.

Following the development of HOPLA, it will be possible to characterise
FM-continuous maps in terms of FM-linear maps whose domain is under an
exponential ${!}$ which captures the appropriate notion of approximation.  Here,
$\typelift\typeP$ will consist of the isolated elements of $\widehat\typeP$
ordered by inclusion.
%
Write $i_{\typeP}$ for the natural inclusion $i_{\typeP} : \typelift\typeP
\hookrightarrow \widehat{\typeP}$.

Each $\widehat{\typeP}$ is the free uniformly-supported-directed-join completion
of $\typelift\typeP$. In detail, this means that $\widehat{\typeP}$ has all
uniformly-supported directed joins (indeed, it has all finitely-supported joins)
and if $C$ is a poset that also has all uniformly-supported directed joins and
$f : \typelift\typeP \to C$ is a monotone finitely-supported function then there
is a unique finitely-supported FM-continuous $f^{\ddagger} : \widehat{\typeP}
\to C$ that such that the following diagram commutes.  \begin{equation}
\label{bang:freeness} \xymatrix{ \typelift\typeP\
\ar@<-4pt>@{^{(}->}[r]^{i_{\typeP}} \ar[dr]_f & \widehat{\typeP}
\ar[d]^{f^{\ddagger}} \\& C} \end{equation} 
%
The function $f^{\ddagger}$ is given by \begin{equation} f^{\ddagger}x \defeq
\bigvee\{f y \mid y \in \typelift\typeP \wedge y \subseteq x \wedge \supp{y}
\subseteq \supp{x, \typeP} \}.\end{equation}
%
Note that this is well-defined since the join is taken over a directed set that
is uniformly supported by $\supp{x, f, \typeP}$, so the join exists in $C$.
%
It is also clear that $f^\ddagger$ is finitely-supported.

\begin{lemma} \label{ddagger:cts} The map $f^{\ddagger}$ is FM-continuous.
\end{lemma}

\begin{proof} It not clear that $f^{\ddagger}$ is even monotone.  Let $x, x' \in
\widehat{\typeP}$ be such that $x \subseteq x'$ and show that $f^{\ddagger} x
\le f^{\ddagger} x'$ as follows. By the monotonicity of $f$ it is sufficient to
show that for all $y \in \typelift\typeP$ such that $y \subseteq x$ and
$\supp{y} \subseteq \supp{x, \typeP}$ there exists $y' \in \typelift\typeP$ such
that $y \subseteq y'$ and $y' \subseteq x'$ and $\supp{y'} \subseteq \supp{x',
\typeP}$, so let $y \in \typelift\typeP$ be such that $y \subseteq x$ and
without loss of generality (by \ref{finelt:wlog}) write $y =
\finelt{F}{\supp{x,x',\typeP}}$.
%
Define $y' = \finelt{F}{\supp{x',\typeP}}$.
%
It is certainly the case that $y \subseteq y'$ (by \ref{finelt:mono}) and
$\supp{y'} \subseteq \supp{x',\typeP}$ (by \ref{fineltsupport}) so it remains to
show that $y' \subseteq x'$.
%
Let $p' \in y'$, then there exists $p \in F$ and $\sigma \freshfor x'$ such that
$p' \le_{\typeP} \sigma \cdot p$.
%
However, since $y = \finelt{F}{\supp{x,x',\typeP}} \subseteq x \subseteq x'$, it
must be that $p \in x'$.
%
Since $\sigma \freshfor x'$, $\sigma \cdot p \in x'$ too, and $x' \in
\widehat{\typeP}$ so that $p' \in x'$ as required.

Having shown that $f^{\ddagger}$ is monotone, the proof of its continuity is
standard.  Let $X \subseteq \widehat{\typeP}$ be uniformly-supported and
directed. For all $x \in X$ it is the case that $f^{\ddagger} x \le f^{\ddagger}
\bigl(\bigcup X \bigr)$ by monotonicity, so $f^{\ddagger} \bigl(\bigcup X\bigr)$
is an upper bound for $\{f^{\ddagger} x \mid x \in X \}$.  It remains to show
that it is the least such upper bound, i.e.  for any $U$ such that $f^{\ddagger}
x \le U$ for all $x \in X$ it is the case that $f^{\ddagger} \bigl(\bigcup
X\bigr) \le U$. For this, it is sufficient to show that $U$ is an upper bound
for $\{f y \mid y \in \typelift\typeP \wedge y \subseteq \bigcup X \wedge
\supp{y} \subseteq \supp{\bigcup X} \}$ since $f^{\ddagger} \bigl(\bigcup X
\bigr)$ is the least such. Therefore, suppose that $y \in \typelift\typeP$ is
such that $y \subseteq \bigcup X$ and $\supp{y} \subseteq \supp{\bigcup X}$.
Then $y$ is isolated, and $X$ is uniformly-supported and directed, so there
exists $x \in X$ such that $y \subseteq x$. It is clear that $f^{\ddagger} y = f
y$, so by monotonicity $f y \le f^{\ddagger} x$ and $f^{\ddagger} x \le U$ so
that $f y \le U$ as required.  \end{proof}

\begin{lemma} \label{bang:alg} If $x \in \widehat{\typeP}$ then \[ x = \bigcup
\{y \in \typelift\typeP \mid y \subseteq x \wedge \supp{y} \subseteq \supp{x,
\typeP} \} \] \end{lemma}

\begin{proof} Certainly $x \supseteq \bigcup \{y \in \typelift\typeP \mid y
\subseteq x \wedge \supp{y} \subseteq \supp{x, \typeP} \}$.
%
To see the converse let $p \in x$ and let $y = \finelt{\{p\}}{\supp{x,
\typeP}}$.
%
It is clear that $p \in y$.
%
By \ref{fineltsupport} it follows that $\supp{y} \subseteq \supp{x, \typeP}$ and
from \ref{finelts} it follows that $y \in \typelift\typeP$.
%
Let $p' \in y$ then by definition there exists $\sigma \freshfor \supp{x,
\typeP}$ such that $p' \le_{\typeP} \sigma \cdot p$, but $\sigma \cdot p \in
\sigma \cdot x = x$ and hence $p' \in x$.
%
Therefore $y \subseteq x$ so as required it follows that \[p \in \bigcup \{y \in
\typelift\typeP \mid y \subseteq x \wedge \supp{y} \subseteq \supp{x, \typeP}
\}. \qedhere\] \end{proof}

Lemma \ref{bang:alg} ensures the uniqueness of $f^{\ddagger}$. Therefore if $f$
and $g$ are FM-continuous maps $\widehat{\typeP} \to \widehat{\typeQ}$ and $f
\circ i_{\typeP} = g \circ i_{\typeP}$ then by \ref{bang:freeness}
\begin{equation} \label{bang:epi} f = (f \circ i_{\typeP})^{\ddagger} = (g \circ
i_{\typeP})^{\ddagger} = g.  \end{equation}

Notice that there is a natural FM-continuous $\eta_{\typeP} : \widehat\typeP \to
\widehat{\typelift\typeP}$ given by $\eta_{\typeP} \defeq
\{\cdot\}_{\typelift\typeP}^{\ddagger}$, or concretely $\eta_{\typeP} X = \{P
\in \typelift\typeP \mid P \subseteq X \}$.
%
In particular, \begin{equation} \label{def:eta} \eta_{\typeP} \circ i_{\typeP} =
\{\cdot\}_{\typelift\typeP}\end{equation} and $\eta$ is the unique such
FM-continuous map.
%
Furthermore for every FM-continuous $f : \widehat\typeP \to \widehat\typeQ$ the
FM-linear function $(f \circ i_{\typeP})^{\dagger} : \widehat{\typelift\typeP}
\to \widehat\typeQ$ satisfies that \begin{equation}
%
(f \circ i_{\typeP})^{\dagger} \circ \eta_{\typeP} = ((f \circ
i_{\typeP})^{\dagger} \circ \eta_{\typeP} \circ i_{\typeP})^{\ddagger} = ((f
\circ i_{\typeP})^{\dagger} \circ \{\cdot\}_{\typelift\typeP})^{\ddagger} = (f
\circ i_{\typeP})^{\ddagger} = f \end{equation} by \ref{hat:freeness} and
\ref{bang:freeness}.
%
Also, if $g : \widehat{\typelift\typeP} \to \widehat\typeQ$ is a FM-linear
function such that $g \circ \eta_{\typeP} = f$ then \begin{equation} (f \circ
i_{\typeP})^{\dagger} = (g \circ \eta_{\typeP} \circ i_{\typeP})^{\dagger} = (g
\circ \{\cdot\}_{\typelift\typeP})^{\dagger} = g.  \end{equation} Therefore $(f
\circ i_{\typeP})^{\dagger}$ is the unique FM-linear function such that the
following diagram commutes.
%
\begin{equation} \label{bang:freechar} \xymatrix{ \widehat{\typeP}\
\ar[r]^{\eta_\typeP} \ar[dr]_f & \widehat{\typelift\typeP} \ar[d]^{(f \circ
i_{\typeP})^{\dagger}} \\& \widehat{\typeQ}} \end{equation} 
%
In other words if $J : \mathbf{FMLin}_s \hookrightarrow \mathbf{FMCts}_s$ then
$\langle \eta_{\typeP}, \typelift\typeP \rangle$ is an initial object of
$(\typeP \downarrow J)$, so the isomorphism \ref{bang:adj} is in fact an
adjunction with $!$ as the left adjoint.
%
Concretely, if $f : \typeP \to \typeQ$ is an arrow of $\mathbf{FMCts}_s$ then
\begin{equation} \label{def:banglin} {!}f \defeq (\eta_{\typeQ} \circ f \circ
i_{\typeP})^{\dagger} : \typelift\typeP \to \typelift\typeQ, \end{equation}
which means that if $X \in \widehat{\typelift\typeP}$ then ${!}f(X) = \{y \in
\typelift\typeQ \mid \exists x \in X.\ y \subseteq f x\}$.
%
The unit of the adjunction is $\eta$ as defined above and the counit $\epsilon$
is defined as $\epsilon_{\typeP} \defeq i_{\typeP}^{\dagger}$.
%
Therefore $\epsilon_{\typeP}$ is the unique FM-linear map such that
\begin{equation} \label{def:epsilon} \epsilon_{\typeP} \circ
\{\cdot\}_{\typelift\typeP} = i_{\typeP}. \end{equation}

\subsection{The Structure of $\mathbf{FMCts}_s$}
\TODO{Prose intro}

\subsubsection{Hom-sets.}

The chain of isomorphisms \begin{equation} \label{cts:homsets}
\begin{array}[t]{rcll} \mathbf{FMCts}_{s}(\typeP, \typeQ)
%
&\cong& \mathbf{FMLin}_{s}({!}\typeP, \typeQ) & \text{by \ref{bang:adj}} \\
%
&\cong& \{x \in \matthat{{!}\typeP^{\mathrm{op}} \times \typeQ} \mid \supp{x}
\subseteq s\} & \text{by \ref{homsets}} \end{array}\end{equation} characterises
hom-sets in $\mathbf{FMCts}_s$.
%
As in $\mathbf{FMLin}_s$ each hom-set may be endowed with a partial order
structure, given by $\subseteq$, and joins given by union.
%
Furthermore composition preserves joins in both its arguments, and in particular
it is monotone.

\subsubsection{Biproducts.}
\TODO{Biproducts}

\subsubsection{Exponentials.}
\TODO{Exponentials}

\subsubsection{Name-Binding.}
\TODO{Name-Binding}

\begin{lemma} \label{freshhat:continuous} If $f : \widehat\typeP \to
\widehat\typeQ$ is FM-continuous then so is $\phi_{\typeQ} \circ f^{\freshfor a}
\circ \phi^{-1}_{\typeP} : \widehat{\typeP^{\freshfor a}} \to
\widehat{\typeQ^{\freshfor a}}$. \end{lemma}

\begin{proof} Let $X \subseteq \widehat{\typeP^{\freshfor a}}$ be directed and
uniformly supported by $s'$.
%
Without loss of generality assume that $a \in s'$ and $s \subseteq s'$.
%
It is required to show that \[ \bigcup\{ (\phi_{\typeQ} \circ f^{\freshfor a}
\circ \phi^{-1}_{\typeP})(x) \mid x \in X \} = (\phi_{\typeQ} \circ f^{\freshfor
a} \circ \phi^{-1}_{\typeP}) \left(\bigcup X\right). \]
%
Let $p \in \bigcup\{ (\phi_{\typeQ} \circ f^{\freshfor a} \circ
\phi^{-1}_{\typeP})(x) \mid x \in X \}$ and let $x \in X$ be such that $p \in
(\phi_{\typeQ} \circ f^{\freshfor a} \circ \phi^{-1}_{\typeP})(x)$, then $x
\subseteq \bigcup X$ so that by monotonicity $p \in (\phi_{\typeQ} \circ
f^{\freshfor a} \circ \phi^{-1}_{\typeP}) \left(\bigcup X\right)$.
%
Conversely let $p \in (\phi_{\typeQ} \circ f^{\freshfor a} \circ
\phi^{-1}_{\typeP}) \left(\bigcup X\right)$ then $p \freshfor a$ and $p \in
f\left(\phi^{-1}_{\typeP} \left(\bigcup X\right)\right)$.
%
By \ref{bang:alg} it is the case that $\phi^{-1}_{\typeP} \left(\bigcup X\right)
= \bigcup \{P \in \typelift\typeP \mid P \subseteq
\phi^{-1}_{\typeP}\left(\bigcup X\right) \wedge \supp{P} \subseteq
\supp{\phi^{-1}_{\typeP} \left(\bigcup X\right)}\}$.
%
Since $f$ is FM-continuous there exists $P \in \typelift\typeP$ such that $P
\subseteq \phi^{-1}_{\typeP}\left(\bigcup X\right)$ and $\supp{P} \subseteq
\supp{\phi^{-1}_{\typeP} \left(\bigcup X\right)}$ and $p \in fP$.
%
Notice that $\supp{\phi^{-1}_{\typeP} \left(\bigcup X\right)} \subseteq s'$ so
that by $\ref{finelt:wlog}$ there exist $p_1, \ldots, p_n \in \phi^{-1}_{\typeP}
\left(\bigcup X\right)$ such that $p \in f(\finelt{\{p_1, \ldots, p_n\}}{s'})$.
%
Let $b$ be a fresh name, then from \ref{characterisation:phiinv} it follows that
$ (ab) \cdot p_i \in \bigcup X$ for all $i$ so that there exist $x_1, \ldots,
x_n \in X$ such that $(ab) \cdot p_i \in x_i$.
%
However, $X$ is directed so there exists $x \in X$ such that $x_i \subseteq x$
for all $i$, and $X$ is uniformly supported by $s'$ so that $\supp{x} \subseteq
s'$ and hence $\finelt{\{p_1, \ldots, p_n\}}{s'} \subseteq (ab) \cdot x
\subseteq \phi^{-1}_{\typeP} (x)$.
%
Therefore $p \in (\phi_{\typeQ} \circ f^{\freshfor a} \circ
\phi^{-1}_{\typeP})(x)$ as required.  \end{proof}

\begin{lemma} \label{deltahat:continuous} If $f : \widehat{\typeP} \to
\widehat{\typeQ}$ is FM-continuous then so is $\theta_{\typeQ} \circ \delta_a f
\circ \theta^{-1}_{\typeP} : \widehat{\delta_a \typeP} \to \widehat{\delta_a
\typeQ}$.  \end{lemma}

\begin{proof} Let $X \subseteq \widehat{\delta_a \typeP}$ be directed and
uniformly supported by $s'$. Without loss of generality assume that $a \in s'$
and $s \subseteq s'$.
%
It is required to show that \[\bigcup \{(\theta_\typeQ \circ \delta_a f \circ
\theta^{-1}_{\typeP}) (x) \mid x \in X \} = (\theta_\typeQ \circ \delta_a f
\circ \theta^{-1}_{\typeP}) \left( \bigcup X \right).\]
%
Let $p \in \bigcup \{(\theta_\typeQ \circ \delta_a f \circ \theta^{-1}_{\typeP})
(x) \mid x \in X \}$ and let $x \in X$ be such that $p \in (\theta_\typeQ \circ
\delta_a f \circ \theta^{-1}_{\typeP}) (x)$, then $x \subseteq \bigcup X$ so
that by monotonicity $p \in  (\theta_\typeQ \circ \delta_a f \circ
\theta^{-1}_{\typeP}) \left( \bigcup X \right)$.
%
Conversely let $p \in (\theta_\typeQ \circ \delta_a f \circ
\theta^{-1}_{\typeP}) \left( \bigcup X \right)$ and let $b$ be a fresh name.
%
Therefore $p@b \in \left((\delta_a f \circ \theta^{-1}_{\typeP}) \left( \bigcup
X \right) \right) @b = f \left( \left( \theta^{-1}_{\typeP} \left( \bigcup X
\right) \right) @b\right)$.
%
By \ref{bang:alg} $\left( \theta^{-1}_{\typeP} \left( \bigcup X \right) \right)
@b = \bigcup \{P \in \typelift\typeP \mid P \subseteq \left(
\theta^{-1}_{\typeP} \left( \bigcup X \right) \right) @b \wedge \supp{P}
\subseteq \supp{\left( \theta^{-1}_{\typeP} \left( \bigcup X \right) \right) @b}
\}$.
%
Since $f$ is FM-continuous there exists $P \in \typelift\typeP$ such that $ P
\subseteq \left( \theta^{-1}_{\typeP} \left( \bigcup X \right) \right) @b$ and
$\supp{P} \subseteq \supp{\left( \theta^{-1}_{\typeP} \left( \bigcup X \right)
\right) @b}$ and $p@b \in fP$.
%
Notice that $\supp{\left( \theta^{-1}_{\typeP} \left( \bigcup X \right) \right)
@b} \subseteq s' \cup \{b\}$ so that by \ref{finelt:wlog} there exist $p_1,
\ldots, p_n \in \left( \theta^{-1}_{\typeP} \left( \bigcup X \right) \right) @b$
such that $p@b \in f(\finelt{\{p_1, \ldots, p_n\}}{s' \cup \{b\}})$.
%
As $b \freshfor \bigcup X$ it follows that $[b].p_i \in \bigcup X$ and hence
there exists $x_i \in X$ such that $[b].p_i \in x_i$ for all $i$.
%
However $X$ is directed so there exists $x \in X$ such that $x_i \subseteq x$
for all $i$, and $X$ is uniformly supported by $s'$ so that $\supp{x} \subseteq
s'$ and hence $\finelt{\{[b].p_1, \ldots, [b].p_n\}}{s'} \subseteq x$.
%
Therefore $\finelt{\{p_1, \ldots, p_n\}}{s' \udot \{b\}} = \left(
\theta^{-1}_{\typeP} \finelt{\{[b].p_1, \ldots, [b].p_n\}}{s'} \right)@b
\subseteq \left( \theta^{-1}_{\typeP} x \right)@b$ so that $p@b \in f
\left(\left( \theta^{-1}_{\typeP} (x) \right)@b\right) = \left( (\delta_a f
\circ \theta^{-1}_{\typeP}) (x) \right)@b$ and hence $p \in (\theta_{\typeQ}
\circ \delta_a f \circ \theta^{-1}_{\typeP}) (x)$ as required.  \end{proof}







% vim: set filetype=tex foldlevel=0 cms=\%%s nowrap tw=80:
